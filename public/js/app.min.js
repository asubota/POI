/*! POI - v0.0.1 - 2014-07-16 */
var PoiManager=new Backbone.Marionette.Application;PoiManager.Poi=Backbone.Model.extend({defaults:function(){return{title:"New POI title",description:"New POI description",lat:null,lng:null,visited:!1,time:"1h",photo:{small:{url:"/images/pois/small_default.jpg"},medium:{url:"/images/pois/medium_default.jpg"},full:{url:"/images/pois/full_default.jpg"}}}},urlRoot:"/api/pois"}),PoiManager.PoiCollection=Backbone.Collection.extend({model:PoiManager.Poi,url:"/api/pois",visited:function(){return this.where({visited:!0})}}),PoiManager.PoiItemView=Marionette.ItemView.extend({template:"#template-poi-item",className:"column",modelEvents:{change:"render"},events:{"click .js-poi-delete-btn":"deleteClicked","click .js-poi-info-btn":"showClicked","click .js-poi-edit-btn":"editClicked"},onRender:function(){PoiManager.vent.trigger("map:marker:update",this.model)},deleteClicked:function(){PoiManager.vent.trigger("map:marker:delete",this.model),this.model.destroy()},editClicked:function(){this.trigger("poi:edit",this.model)},showClicked:function(){this.trigger("poi:show",this.model)}}),PoiManager.PoisView=Marionette.CompositeView.extend({childView:PoiManager.PoiItemView,className:"ui grid one column page",template:"#template-poi-list",childViewContainer:"div.poi-list-items",events:{"click .js-poi-new-btn":"showModal"},ui:{mapClick:".js-poi-add-on-map",mapCluster:".js-poi-cluster"},showModal:function(a,b){var c=new PoiManager.ModalView({model:b||new PoiManager.Poi,collection:this.collection});PoiManager.modalRegion.show(c),$(".ui.modal").modal("show")},onRender:function(){var a=_.object(_.map(["cluster","dblclick"],function(a){return[a,{onEnable:function(){PoiManager.vent.trigger(["map:option",a].join(":"),!0)},onDisable:function(){PoiManager.vent.trigger(["map:option",a].join(":"),!1)}}]}));this.ui.mapClick.checkbox(a.dblclick),this.ui.mapCluster.checkbox("enable").checkbox(a.cluster)},_showDetails:function(a){var b=new PoiManager.DetailsView({model:a});PoiManager.detailsRegion.show(b),PoiManager.vent.trigger("map:marker:panto",a)},onChildviewPoiShow:function(a,b){this._showDetails(b)},onChildviewPoiEdit:function(a,b){this.showModal(null,b)},initialize:function(){var a=this;PoiManager.vent.on("map:marker:new",function(b){a.showModal(null,new PoiManager.Poi(b))}),PoiManager.vent.on("map:marker:click",function(b){a._showDetails(b)})}}),PoiManager.ModalView=Marionette.ItemView.extend({template:"#template-modal",className:"ui modal",events:{"click .js-poi-save-btn":"trySave","change .js-poi-photo-file":"preview"},preview:function(a){if($(a.target).val()){var b=this,c=a.target.files[0],d=new FormData;d.append("photo",c),$.ajax({contentType:!1,processData:!1,url:"/upload",data:d,type:"POST",success:function(a){var c=a.photo.url;b.$(".poi-lat").val(a.lat),b.$(".poi-lng").val(a.lng),b.$(".poi-photo_path").val(c),b.$(".poi-photo-preview").attr("src",c)}})}},trySave:function(){var a=["title","description","lat","lng","photo_path","time"],b={};_.each(a,function(a){b[a]=this.$(".poi-"+a).val()},this),this.model.isNew()&&this.collection.add(this.model),this.model.save(b,{success:function(a,b){a.set("photo",b.photo)}})}}),PoiManager.DetailsView=Marionette.ItemView.extend({template:"#template-details",className:"ui piled teal segment",modelEvents:{change:"render",remove:"clear"},clear:function(){PoiManager.detailsRegion.reset()}}),PoiManager.addRegions({modalRegion:".poi-region-modal",poisRegion:".poi-region-list",detailsRegion:".poi-region-details"}),PoiManager.on("start",function(){var a=new PoiManager.PoiCollection;a.fetch({success:function(a){var b=new PoiManager.PoisView({collection:a});PoiManager.poisRegion.show(b)}})}),PoiManager.start();var MAP={map:L.map("map",{maxZoom:18}).setView([50.414124,30.522423],13),options:{dblclickToAddMarker:!1,markerClustering:!0},getCoords:function(a){return _.map(["lat","lng"],function(b){return parseFloat(a.get(b))})},markerAdd:function(a){var b=this.getCoords(a),c=_.size(_.compact(b));2===c&&(a.marker=L.marker(b).bindPopup(a.get("title")),this._bindMarker(a),this.currentMarkersGroup().addLayer(a.marker))},markerDelete:function(a){a.marker&&(this.currentMarkersGroup().removeLayer(a.marker),a.marker=null)},_bindMarker:function(a){a.marker.on("dragend",function(){a.save(this.getLatLng())}),a.marker.on("dblclick",function(){this.dragging.enabled()?(this.dragging.disable(),this._icon.src=this._icon.src.replace("active-","")):(this.dragging.enable(),this._icon.src=this._icon.src.replace("/images/marker","/images/active-marker"))}),a.marker.on("click",function(){PoiManager.vent.trigger("map:marker:click",a)})},_updateMarkerTitle:function(a){a.marker&&a.marker.setPopupContent(a.get("title"))},_updateMarkerGeo:function(a){var b,c;a.marker?(b=this.getCoords(a),c=_.size(_.compact(b)),2===c?a.marker.setLatLng(b):this.markerDelete(a)):this.markerAdd(a)},markerUpdate:function(a){this._updateMarkerTitle(a),this._updateMarkerGeo(a)},markers:{cluster:L.markerClusterGroup({spiderfyOnMaxZoom:!1,showCoverageOnHover:!1,zoomToBoundsOnClick:!1}),common:L.layerGroup()},currentMarkersGroup:function(){return this.options.markerClustering?this.markers.cluster:this.markers.common}};_.each(MAP.markers,function(a){a.addTo(MAP.map)}),MAP.markers.cluster.on("clusterclick",function(a){a.layer.zoomToBounds()}),L.Icon.Default.imagePath="/images",L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png").addTo(MAP.map),PoiManager.vent.on("map:marker:panto",function(a){a.marker&&(MAP.map.panTo(a.marker._latlng),a.marker.openPopup())}),PoiManager.vent.on("map:marker:delete",function(a){MAP.markerDelete(a)}),PoiManager.vent.on("map:marker:update",function(a){MAP.markerUpdate(a)}),PoiManager.vent.on("map:option:dblclick",function(a){MAP.options.dblclickToAddMarker=a}),PoiManager.vent.on("map:option:cluster",function(a){var b=MAP.currentMarkersGroup(),c=b.getLayers();b.clearLayers(),MAP.options.markerClustering=a,_.each(c,function(a){this.addLayer(a)},MAP.currentMarkersGroup())}),MAP.map.on("dblclick",function(a){return MAP.options.dblclickToAddMarker?(this.doubleClickZoom.disable(),void PoiManager.vent.trigger("map:marker:new",a.latlng)):void this.doubleClickZoom.enable()});