/*! POI - v0.0.1 - 2014-07-03 */
var PoiManager=new Marionette.Application;PoiManager.Poi=Backbone.Model.extend({defaults:function(){return{title:"New POI title",description:"New POI description",lat:null,lng:null,visited:!1,photo:"images/pois/thumb/default.jpg",time:"1h"}},urlRoot:"/api/pois"}),PoiManager.PoiCollection=Backbone.Collection.extend({model:PoiManager.Poi,url:"/api/pois",visited:function(){return this.where({visited:!0})}}),PoiManager.PoiItemView=Marionette.ItemView.extend({template:"#template-poi-item",className:"column",modelEvents:{"change:title":"render","change:photo":"render","change:lat":"updateMarker","change:lng":"updateMarker"},events:{"click .js-poi-delete-btn":"deleteClicked","click .js-poi-info-btn":"showClicked","click .js-poi-edit-btn":"editClicked"},deleteClicked:function(){this.deleteMarker(),this.trigger("poi:delete",this.model)},editClicked:function(){this.trigger("poi:edit",this.model)},showClicked:function(){this.trigger("poi:show",this.model)},_getCoords:function(){return _.map(["lat","lng"],function(a){return parseFloat(this.model.get(a))},this)},setMarker:function(){var a=this.model,b=this._getCoords();size=_.size(_.compact(b)),a.marker||2!==size?2!==size&&this.deleteMarker():(a.marker=L.marker(b).bindPopup(),a.marker.on("dragend",function(){a.save(this.getLatLng())}).on("dblclick",function(){this.dragging.enabled()?(this.dragging.disable(),this._icon.src=this._icon.src.replace("active-","")):(this.dragging.enable(),this._icon.src=this._icon.src.replace("/images/marker","/images/active-marker"))}))},updateMarker:function(){var a=this.model;this.setMarker(),this.showMarker(),a.marker&&this.model.marker.setLatLng(this._getCoords())},showMarker:function(){var a=this.model;a.marker&&(PoiManager.markers.addLayer(a.marker),a.marker.setPopupContent(a.get("title")))},deleteMarker:function(){var a=this.model;a.marker&&(PoiManager.markers.removeLayer(a.marker),a.marker=null)},onRender:function(){this.setMarker(),this.showMarker()}}),PoiManager.PoisView=Marionette.CompositeView.extend({childView:PoiManager.PoiItemView,className:"ui grid one column page",template:"#template-poi-list",childViewContainer:"div.poi-list-items",events:{"click .js-poi-new-btn":"showModal"},ui:{mapClick:".ui.slider.checkbox"},showModal:function(a,b){var c=new PoiManager.ModalView({model:b||new PoiManager.Poi,collection:this.collection});PoiManager.modalRegion.show(c),$(".ui.modal").modal("show")},onRender:function(){this.ui.mapClick.checkbox()},initialize:function(){var a=this;this.on("childview:poi:show",function(a,b){var c=new PoiManager.DetailsView({model:b});PoiManager.detailsRegion.show(c)}),this.on("childview:poi:edit",function(a,b){this.showModal(null,b)}),this.on("childview:poi:delete",function(a,b){b.destroy()}),PoiManager.map.on("dblclick",function(b){if(!a.ui.mapClick.find("input").filter(":checked").length)return void this.doubleClickZoom.enable();this.doubleClickZoom.disable();var c=new PoiManager.Poi({lat:b.latlng.lat,lng:b.latlng.lng});a.showModal(null,c)})}}),PoiManager.ModalView=Marionette.ItemView.extend({template:"#template-modal",className:"ui modal",events:{"click .js-poi-save-btn":"trySave","change .js-poi-photo-file":"tryUpload"},tryUpload:function(a){var b=this;$(a.target).val()&&this.$("form").ajaxSubmit({complete:function(a){var c=a.responseJSON.url;b.$(".poi-photo").val(c),b.$(".poi-photo-preview").attr("src",c)}})},trySave:function(){var a=["title","description","lat","lng","photo","time"],b={};_.each(a,function(a){b[a]=this.$(".poi-"+a).val()},this),this.model.isNew()&&this.collection.add(this.model),this.model.save(b)}}),PoiManager.DetailsView=Marionette.ItemView.extend({template:"#template-details",className:"ui piled teal segment",modelEvents:{"change:time":"render","change:title":"render","change:description":"render",remove:"clear"},clear:function(){PoiManager.detailsRegion.reset()}}),PoiManager.map=L.map("map").setView([50.414124,30.522423],13),L.Icon.Default.imagePath="/images",L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png").addTo(PoiManager.map),PoiManager.markers=L.layerGroup().addTo(PoiManager.map),PoiManager.addRegions({modalRegion:".poi-region-modal",poisRegion:".poi-region-list",detailsRegion:".poi-region-details"}),PoiManager.on("start",function(){var a=new PoiManager.PoiCollection;a.fetch({success:function(a){var b=new PoiManager.PoisView({collection:a});PoiManager.poisRegion.show(b)}})}),PoiManager.start();